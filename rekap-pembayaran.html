<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Rekap Pembayaran</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f6f2; --surface:#fff; --border:#e6ebee; --text:#11292a; --muted:#6b7c7d;
      --accent:#1a686a; --accent-2:#17464a; --shadow:0 6px 18px rgba(17,24,39,.06); --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);line-height:1.45}
    .wrap{max-width:720px;margin:18px auto 120px;padding:0 16px}
    .appbar{position:sticky;top:0;z-index:20;background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px;font-weight:700}

    /* Card */
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
    .section-title{font-weight:700;margin:2px 2px 10px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px 0}
    .row + .row{border-top:1px dashed var(--border)}
    .label{color:var(--muted)}
    .value b{color:var(--text)}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fbfbfb;color:var(--muted)}
    .chip.paket{background:#eef7f7;color:#136666;border-color:#d9efef;font-weight:700}
    .divider{height:1px;background:var(--border);margin:8px 0}

    /* Items list */
    .items{list-style:none;margin:8px 0 10px;padding:0;display:grid;gap:8px}
    .items li{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;align-items:center}
    .itm-name{font-weight:600}
    .qty{min-width:28px;text-align:right}
    .price{min-width:90px;text-align:right}
    .subtotal{min-width:100px;text-align:right;font-weight:700}

    /* Package usage */
    .progress{height:8px;border-radius:999px;background:#edf2f4;overflow:hidden}
    .progress > span{display:block;height:100%;background:linear-gradient(90deg,#1a686a,#2aa6a4)}

    /* Inputs */
    .field{display:flex;align-items:center;gap:8px}
    .field input[type="number"]{width:140px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-weight:600}
    .switch{position:relative;display:inline-block;width:46px;height:26px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:#e9eef0;border-radius:20px;transition:.2s}
    .slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;top:3px;background:#fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.2);transition:.2s}
    .switch input:checked + .slider{background:#cfe7e7}
    .switch input:checked + .slider:before{transform:translateX(20px)}
    .help{font-size:12px;color:var(--muted);margin-top:6px}

    /* Payment method chips */
    .paychips{display:flex;gap:8px;flex-wrap:wrap}
    .paychips button{appearance:none;border:1px solid var(--border);background:#f8fafb;cursor:pointer;padding:8px 12px;border-radius:999px;font-weight:600}
    .paychips button.active{background:var(--accent);color:#fff;border-color:var(--accent)}

    /* Sticky summary */
    .sticky{position:fixed;left:0;right:0;bottom:0;background:var(--surface);border-top:1px solid var(--border);z-index:30}
    .sticky .inner{max-width:720px;margin:0 auto;padding:10px 16px;display:grid;gap:10px}
    .totline{display:flex;justify-content:space-between;align-items:center}
    .cta{appearance:none;border:0;background:var(--accent-2);color:#fff;font-weight:800;padding:14px 16px;border-radius:12px;letter-spacing:.3px}
    .cta:active{filter:brightness(.96)}
    .subnote{font-size:12px;color:var(--muted)}

    .right{text-align:right}
    @media (max-width:440px){ .items li{grid-template-columns:1fr auto auto} .subtotal{display:none} }
  </style>
</head>
<body>
  <div class="appbar">Rekap Pembayaran</div>

  <div class="wrap">
    <!-- Ringkasan Treatment -->
    <div class="card">
      <div class="section-title">Ringkasan Treatment</div>
      <ul class="items" id="itemList"></ul>
      <div class="divider"></div>
      <div class="row">
        <div class="label">Total durasi</div>
        <div class="value"><span id="totalMin">0</span> mnt • <span id="totalItem">0</span> item</div>
      </div>
    </div>

    <!-- Pemakaian Paket -->
    <div class="card" id="pkgCard">
      <div class="section-title" id="pkgTitle">Pemakaian Paket</div>
      <div class="row">
        <div class="label">Terpakai hari ini</div>
        <div class="value"><b id="usedToday">0 sesi (0 mnt)</b></div>
      </div>
      <div class="row">
        <div class="label">Sisa setelah transaksi</div>
        <div class="value"><b id="remainAfter">0/0 sesi</b></div>
      </div>
      <div class="progress" aria-hidden="true"><span id="pkgProg" style="width:0%"></span></div>
      <div class="help" id="pkgHelp">1 sesi = 30 menit treatment.</div>
    </div>

    <!-- Opsi Pembayaran -->
    <div class="card">
      <div class="section-title">Metode Pembayaran</div>
      <div class="paychips" id="paychips">
        <button class="active" data-method="cash">Tunai</button>
        <button data-method="qris">QRIS</button>
        <button data-method="card">Kartu</button>
        <button data-method="transfer">Transfer</button>
      </div>
      <div class="help">Pilih salah satu. Biaya admin (jika ada) bisa diisi di bagian Rincian.</div>
    </div>

    <!-- Rincian Tagihan -->
    <div class="card">
      <div class="section-title">Rincian Tagihan</div>
      <div class="row"><div class="label">Subtotal</div><div class="value"><b id="subtotalRp">Rp 0</b></div></div>
      <div class="row">
        <div class="label">Diskon</div>
        <div class="field"><input id="discount" type="number" inputmode="numeric" min="0" step="1000" value="0" /><span class="muted">Rp</span></div>
      </div>
      <div class="row">
        <div class="label">PPN 11%</div>
        <label class="switch"><input id="ppn" type="checkbox"><span class="slider"></span></label>
        <div class="value right" style="min-width:90px"><span id="ppnRp">Rp 0</span></div>
      </div>
      <div class="row">
        <div class="label">Biaya admin</div>
        <div class="field"><input id="adminFee" type="number" inputmode="numeric" min="0" step="1000" value="0" /><span class="muted">Rp</span></div>
      </div>
      <div class="row">
        <div class="label">Gunakan deposit</div>
        <div class="field"><input id="deposit" type="number" inputmode="numeric" min="0" step="1000" value="0" /><span class="muted">Rp</span></div>
      </div>
      <div class="help">Catatan: deposit tidak boleh melebihi jumlah yang harus dibayar.</div>
    </div>

    <!-- Catatan -->
    <div class="card">
      <div class="section-title">Catatan (opsional)</div>
      <textarea id="note" rows="3" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font-family:inherit"></textarea>
    </div>
  </div>

  <!-- Sticky total & CTA -->
  <div class="sticky">
    <div class="inner">
      <div class="totline">
        <div>
          <div class="muted">Total dibayar</div>
          <div style="font-weight:800;font-size:18px" id="grandRp">Rp 0</div>
        </div>
        <div class="right">
          <div class="subnote">Metode: <span id="methodLabel">Tunai</span></div>
          <div class="subnote" id="changeLine" style="display:none"></div>
        </div>
      </div>
      <button class="cta" id="cta">KONFIRMASI &amp; BAYAR</button>
    </div>
  </div>

  <script>
    // ====== DATA ======
    // Item dari halaman sebelumnya (semua dibayar oleh paket → price=0)
    const items = [
      { name:'Motor UE1', duration:30, qty:1, price:0 },
      { name:'Biofeedback 2', duration:30, qty:1, price:0 }
    ];

    // Info paket yang dipakai
    const PACKAGE = {
      name: 'Paket 8 Sesi',
      totalSessions: 8,          // total kuota paket
      remainingBefore: 8,        // sisa sebelum transaksi
      minutesPerSession: 30      // 1 sesi = 30 menit
    };

    // ====== UTIL ======
    const rp = n => (n<0?'- ':'') + Math.abs(n).toLocaleString('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0});

    // ====== RENDER ITEMS (harga Rp 0 + chip Paket) ======
    const listEl = document.getElementById('itemList');
    function renderItems(){
      listEl.innerHTML = '';
      let totalMin = 0;
      items.forEach(it=>{
        totalMin += it.duration * it.qty;
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="itm-name">${it.name}</span>
          <span class="chip">⏱ ${it.duration} mnt</span>
          <span class="qty">×${it.qty}</span>
          <span class="price"><span class="chip paket">Paket</span> &nbsp; Rp 0</span>
        `;
        listEl.appendChild(li);
      });
      document.getElementById('totalMin').textContent = totalMin;
      document.getElementById('totalItem').textContent = items.length;
    }

    // ====== PAKET: hitung terpakai & sisa ======
    function renderPackage(){
      const usedSessions = items.reduce((s,it)=> s + Math.round((it.duration * it.qty) / PACKAGE.minutesPerSession), 0);
      const usedMinutes  = usedSessions * PACKAGE.minutesPerSession;
      const remainAfter  = Math.max(0, PACKAGE.remainingBefore - usedSessions);
      const pct = (remainAfter / PACKAGE.totalSessions) * 100;

      document.getElementById('pkgTitle').textContent = `Pemakaian Paket — ${PACKAGE.name}`;
      document.getElementById('usedToday').textContent = `${usedSessions} sesi (${usedMinutes} mnt)`;
      document.getElementById('remainAfter').textContent = `${remainAfter}/${PACKAGE.totalSessions} sesi`;
      document.getElementById('pkgProg').style.width = `${pct}%`;
      document.getElementById('pkgHelp').textContent = `1 sesi = ${PACKAGE.minutesPerSession} menit treatment.`;
    }

    // ====== TOTALS ======
    const discountEl = document.getElementById('discount');
    const ppnEl = document.getElementById('ppn');
    const adminFeeEl = document.getElementById('adminFee');
    const depositEl = document.getElementById('deposit');
    const subtotalRp = document.getElementById('subtotalRp');
    const ppnRp = document.getElementById('ppnRp');
    const grandRp = document.getElementById('grandRp');
    const changeLine = document.getElementById('changeLine');

    function compute(){
      const subtotal = items.reduce((s,it)=> s + (it.price||0)*it.qty, 0); // -> 0 saat pakai paket
      const discount = Math.max(0, +discountEl.value||0);
      const adminFee = Math.max(0, +adminFeeEl.value||0);

      // PPN dihitung dari (subtotal - diskon); jika 0 → PPN 0
      const ppnBase = Math.max(0, subtotal - discount);
      const ppn = ppnEl.checked ? Math.round(0.11 * ppnBase) : 0;

      // Deposit tidak boleh melebihi total kena bayar
      const maxDeposit = Math.max(0, subtotal - discount + ppn + adminFee);
      let deposit = Math.max(0, +depositEl.value||0);
      if(deposit > maxDeposit){ deposit = maxDeposit; depositEl.value = deposit; }

      const grand = subtotal - discount + ppn + adminFee - deposit;

      subtotalRp.textContent = rp(subtotal);
      ppnRp.textContent = rp(ppn);
      grandRp.textContent = rp(grand);
      changeLine.style.display = 'none';
    }

    // ====== METODE ======
    const chips = document.getElementById('paychips');
    const methodLabel = document.getElementById('methodLabel');
    chips.addEventListener('click', e=>{
      const btn = e.target.closest('button'); if(!btn) return;
      chips.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      methodLabel.textContent = ({cash:'Tunai', qris:'QRIS', card:'Kartu', transfer:'Transfer'})[btn.dataset.method] || 'Tunai';
    });

    // ====== CTA ======
    document.getElementById('cta').addEventListener('click', ()=>{
      const payload = {
        items,
        package:{
          name: PACKAGE.name,
          usedSessions: items.reduce((s,it)=> s + Math.round((it.duration*it.qty)/PACKAGE.minutesPerSession), 0),
          minutesPerSession: PACKAGE.minutesPerSession,
          totalSessions: PACKAGE.totalSessions,
          remainingBefore: PACKAGE.remainingBefore
        },
        discount:+discountEl.value||0,
        ppn:ppnEl.checked,
        adminFee:+adminFeeEl.value||0,
        deposit:+depositEl.value||0,
        method: methodLabel.textContent,
        note: document.getElementById('note').value
      };
      alert('Konfirmasi & Bayar (mock)\n' + JSON.stringify(payload, null, 2));
    });

    // ====== INIT ======
    ['input','change'].forEach(ev=>{
      discountEl.addEventListener(ev, compute);
      ppnEl.addEventListener(ev, compute);
      adminFeeEl.addEventListener(ev, compute);
      depositEl.addEventListener(ev, compute);
    });
    renderItems();
    renderPackage();
    compute();
  </script>
</body>
</html>
