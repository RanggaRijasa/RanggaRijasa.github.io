<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>Stimel-03 â€¢ Therapy Logger (Mobile)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;         /* slate-950 */
      --card:#111827;       /* gray-900 */
      --muted:#94a3b8;      /* slate-400 */
      --text:#e5e7eb;       /* gray-200 */
      --primary:#22c55e;    /* emerald-500 */
      --primary-pressed:#16a34a; /* emerald-600 */
      --accent:#38bdf8;     /* sky-400 */
      --danger:#ef4444;     /* red-500 */
      --warning:#f59e0b;    /* amber-500 */
      --ring: 0 0 0 2px rgba(56,189,248,.35);
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0f172a);color:var(--text);font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    .container{max-width:680px;margin:0 auto;padding:16px 16px 120px}
    header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(11,18,32,.9),rgba(11,18,32,.5));backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.15)}
    .head{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 180deg at 50% 50%,var(--accent),var(--primary));box-shadow:0 6px 16px rgba(34,197,94,.35)}
    h1{font-size:17px;margin:0;letter-spacing:.2px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;background:#1f2937;color:var(--text);font-weight:600;cursor:pointer;box-shadow:var(--shadow);transition:.2s}
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:var(--primary);color:#04130a}
    .btn.primary:active{transform:translateY(1px);background:var(--primary-pressed)}
    .btn.ghost{background:transparent;border:1px solid rgba(148,163,184,.35)}
    .grid{display:grid;gap:14px}
    .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid rgba(148,163,184,.12);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:13px 12px;border-radius:12px;background:#0b1220;border:1px solid rgba(148,163,184,.35);color:var(--text);outline:none}
    input:focus,select:focus{box-shadow:var(--ring)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:6px 10px;font-size:12px}
    .inline{display:flex;align-items:center;gap:10px}
    .steps{display:flex;gap:8px;align-items:center;margin:8px 0 14px}
    .dot{width:8px;height:8px;border-radius:999px;background:#1f2937;border:1px solid rgba(148,163,184,.35)}
    .dot.active{background:var(--accent);box-shadow:0 0 0 4px rgba(56,189,248,.15)}
    .actions{position:fixed;left:0;right:0;bottom:0;z-index:40;background:linear-gradient(180deg,rgba(11,18,32,.2),rgba(11,18,32,.9));backdrop-filter:blur(8px);border-top:1px solid rgba(148,163,184,.12)}
    .actions .bar{max-width:680px;margin:0 auto;display:flex;gap:10px;padding:12px 16px}
    .toast{position:fixed;inset:auto 12px 88px;z-index:50;padding:12px 14px;border-radius:12px;background:#0b1220;border:1px solid rgba(148,163,184,.35);box-shadow:var(--shadow);display:none}
    .toast.show{display:block}
    .counter{font-weight:700;font-size:14px}
    .range-wrap{display:flex;gap:10px;align-items:center}
    input[type="range"]{accent-color:var(--accent);width:100%}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(148,163,184,.25),transparent);margin:8px 0 4px}
    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;padding:16px;background:rgba(2,6,23,.65);backdrop-filter:blur(6px);z-index:60}
    .modal.show{display:grid}
    .sheet{width:min(560px,100%);background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid rgba(148,163,184,.18);border-radius:20px;box-shadow:var(--shadow);padding:16px}
    .sheet h3{margin:6px 0 2px}
    .qr{display:grid;place-items:center;padding:14px;background:#0b1220;border:1px dashed rgba(148,163,184,.35);border-radius:14px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-weight:600}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(148,163,184,.15);padding:10px;font-size:13px;text-align:left}
    .scroll{overflow:auto;max-height:60vh}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid rgba(148,163,184,.25);font-size:12px}
    .empty{padding:16px;border:1px dashed rgba(148,163,184,.25);border-radius:14px;color:var(--muted);text-align:center}

    /* Pad placement cards */
    .loc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .loc-card{position:relative;display:flex;gap:10px;align-items:center;padding:10px;border-radius:14px;background:#0b1220;border:1px solid rgba(148,163,184,.25);cursor:pointer;transition:.15s}
    .loc-card:hover{filter:brightness(1.05)}
    .loc-card.selected{outline:2px solid var(--accent);box-shadow:0 0 0 6px rgba(56,189,248,.12)}
    .loc-fig{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:#0a0f1c;border:1px solid rgba(148,163,184,.25)}
    .loc-title{font-weight:600}
    .loc-sub{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="head">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Stimelâ€‘03 â€¢ Therapy Logger</h1>
          <div class="muted" style="font-size:12px">Mobile UI â€¢ QRIS Payment â€¢ Laporan</div>
        </div>
      </div>
      <div class="inline">
        <button id="reportBtn" class="btn ghost" aria-label="Lihat laporan" style="display:none">Laporan</button>
        <button id="resetAllBtn" class="btn ghost" title="Hapus semua data lokal">Reset</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Step indicators -->
    <div class="steps" id="stepDots" aria-label="Progress langkah"></div>

    <button type="button" onclick="location.href='treatmentmockup.html'" class="btn-link">
  Open Treatment Planner
</button>


    <div class="card grid" id="formCard">
      <!-- BEGINNING addition -->
      <div>
        <div class="label">Awal â€¢ <span class="muted">Memilih pasien â€” otomatis simpan <strong>tanggal, waktu (tersembunyi), dan perawat</strong></span></div>
        <div class="row">
          <div>
            <label class="label" for="nurse">Nama Perawat</label>
            <input id="nurse" placeholder="Isi nama perawat" autocomplete="name" />
          </div>
          <div>
            <label class="label" for="patient">Nama Pasien</label>
            <input id="patient" placeholder="Pilih / ketik nama pasien" list="patientList" />
            <datalist id="patientList"></datalist>
          </div>
        </div>
        <!-- System time hidden visually but still recorded -->
        <div class="inline" id="systemTimePill" style="margin-top:8px; display:none">
          <span class="pill">Waktu sistem: <span id="nowStr" class="kbd"></span></span>
          <span id="autoSaveBadge" class="pill" style="display:none">âœ… Tersimpan otomatis</span>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Step 1: Letak terapi (with pad images) -->
      <div>
        <span class="label">1) Memilih letak terapi</span>
        <input id="location" type="hidden" />
        <div class="loc-grid" id="locGrid" role="listbox" aria-label="Letak terapi">
          <!-- Cards with simple inline SVGs to guide pad placement -->
          <div class="loc-card" data-value="Wrist/Finger Extensors" tabindex="0" role="option" aria-label="Wrist/Finger Extensors">
            <div class="loc-fig" aria-hidden="true">
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="8" y="8" width="24" height="8" rx="4" stroke="#93c5fd"/>
                <rect x="20" y="20" width="12" height="6" rx="2" fill="#22c55e"/>
                <rect x="8" y="20" width="12" height="6" rx="2" fill="#22c55e"/>
              </svg>
            </div>
            <div>
              <div class="loc-title">Wrist/Finger Extensors</div>
              <div class="loc-sub">Pad di kedua sisi lengan bawah</div>
            </div>
          </div>
          <div class="loc-card" data-value="Ankle (Drop Foot)" tabindex="0" role="option" aria-label="Ankle (Drop Foot)">
            <div class="loc-fig" aria-hidden="true">
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 8c10 0 14 8 14 14v6h6" stroke="#93c5fd"/>
                <rect x="10" y="22" width="10" height="6" rx="2" fill="#22c55e"/>
                <rect x="22" y="28" width="10" height="6" rx="2" fill="#22c55e"/>
              </svg>
            </div>
            <div>
              <div class="loc-title">Ankle (Drop Foot)</div>
              <div class="loc-sub">Pad di otot peroneal & tibialis</div>
            </div>
          </div>
          <div class="loc-card" data-value="Quadriceps" tabindex="0" role="option" aria-label="Quadriceps">
            <div class="loc-fig" aria-hidden="true">
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="10" y="10" width="20" height="16" rx="6" stroke="#93c5fd"/>
                <rect x="12" y="12" width="8" height="6" rx="2" fill="#22c55e"/>
                <rect x="20" y="18" width="8" height="6" rx="2" fill="#22c55e"/>
              </svg>
            </div>
            <div>
              <div class="loc-title">Quadriceps</div>
              <div class="loc-sub">Dua pad di paha depan</div>
            </div>
          </div>
          <div class="loc-card" data-value="Hamstring" tabindex="0" role="option" aria-label="Hamstring">
            <div class="loc-fig" aria-hidden="true">
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="10" y="14" width="20" height="14" rx="6" stroke="#93c5fd"/>
                <rect x="12" y="20" width="8" height="6" rx="2" fill="#22c55e"/>
                <rect x="20" y="14" width="8" height="6" rx="2" fill="#22c55e"/>
              </svg>
            </div>
            <div>
              <div class="loc-title">Hamstring</div>
              <div class="loc-sub">Dua pad di paha belakang</div>
            </div>
          </div>
          <div class="loc-card" data-value="Shoulder/Deltoid" tabindex="0" role="option" aria-label="Shoulder/Deltoid">
            <div class="loc-fig" aria-hidden="true">
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="20" cy="14" r="6" stroke="#93c5fd"/>
                <rect x="9" y="22" width="10" height="6" rx="2" fill="#22c55e"/>
                <rect x="21" y="22" width="10" height="6" rx="2" fill="#22c55e"/>
              </svg>
            </div>
            <div>
              <div class="loc-title">Shoulder/Deltoid</div>
              <div class="loc-sub">Pad di deltoid anterior & lateral</div>
            </div>
          </div>
          <div class="loc-card" data-value="Custom (lainnya)" tabindex="0" role="option" aria-label="Custom (lainnya)">
            <div class="loc-fig" aria-hidden="true">
              <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="6" width="28" height="28" rx="8" stroke="#93c5fd"/>
                <path d="M12 20h16M20 12v16" stroke="#22c55e"/>
              </svg>
            </div>
            <div>
              <div class="loc-title">Custom (lainnya)</div>
              <div class="loc-sub">Sesuai kebutuhan klinis</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Jenis terapi -->
      <div>
        <label class="label" for="therapy">2) Memasukkan jenis terapi (Program)</label>
        <select id="therapy">
          <option value="" disabled selected>Pilih program</option>
          <optgroup label="Biofeedback (BFES)">
            <option>Biofeedback 1</option>
            <option>Biofeedback 2</option>
            <option>Biofeedback 3</option>
            <option>Sensitive</option>
            <option>Sensory 1</option>
            <option>Sensory 2</option>
            <option>Sensory/Tone</option>
          </optgroup>
          <optgroup label="NMES (Passive)">
            <option>Motor UE 1</option>
            <option>Motor UE 2</option>
            <option>Motor LE 1</option>
            <option>Motor LE 2</option>
          </optgroup>
        </select>
        <div class="inline" style="margin-top:8px">
          <span class="pill">Counter jenis terapi ini: <span id="therapyCounter" class="counter">0</span></span>
          <span class="muted" style="font-size:12px">(naik otomatis +1 per submit)</span>
        </div>
      </div>

      <!-- Step 3: Durasi (30-min increments) & Auto Price -->
      <div class="row">
        <div>
          <label class="label" for="duration">3) Durasi (kelipatan 30 menit)</label>
          <select id="duration">
            <option value="" disabled selected>Pilih durasi</option>
            <option value="30">30 menit</option>
            <option value="60">60 menit</option>
            <option value="90">90 menit</option>
            <option value="120">120 menit</option>
            <option value="150">150 menit</option>
            <option value="180">180 menit</option>
          </select>
        </div>
        <div>
          <label class="label" for="amountDisplay">Nominal (otomatis oleh sistem)</label>
          <input id="amountDisplay" disabled placeholder="â€”" />
        </div>
      </div>

      <!-- Step 4: Amplitudo -->
      <div>
        <label class="label" for="amplitude">4) Amplitudo (0â€“100)</label>
        <div class="range-wrap">
          <input id="amplitude" type="range" min="0" max="100" value="30" />
          <input id="amplitudeNum" type="number" min="0" max="100" value="30" style="width:90px" />
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px">Gunakan nilai yang aman sesuai respon pasien.</div>
      </div>

      <!-- Note chips -->
      <div class="chips" aria-label="Tips">
        <span class="chip">ðŸ”– Data pasien + perawat tersimpan otomatis</span>
        <span class="chip">ðŸ“ˆ Counter bertambah per jenis terapi</span>
        <span class="chip">ðŸ’³ Submit menampilkan QRIS</span>
      </div>
    </div>

    <div class="empty" style="margin-top:12px">Tombol <strong>Laporan</strong> akan muncul setelah pembayaran <strong>berhasil (lunas)</strong>.</div>
  </main>

  <!-- Bottom actions -->
  <div class="actions">
    <div class="bar">
      <button id="backBtn" class="btn ghost" style="flex:1;display:none">Kembali</button>
      <button id="nextBtn" class="btn" style="flex:1">Lanjut</button>
      <button id="submitBtn" class="btn primary" style="flex:2;display:none">Submit & QRIS</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Payment Modal -->
  <div id="payModal" class="modal" role="dialog" aria-modal="true" aria-label="QRIS Payment">
    <div class="sheet">
      <div class="inline" style="justify-content:space-between">
        <h3>QRIS Payment</h3>
        <button class="btn ghost" id="closePay">Tutup</button>
      </div>
      <div class="muted" style="font-size:13px;margin-bottom:8px">Scan QR berikut untuk melakukan pembayaran. (Demo QR â€” bukan payload resmi QRIS)</div>
      <div class="qr" id="qrisBox"><div id="qrcode"></div></div>
      <div class="row" style="margin-top:12px">
        <button id="markPaid" class="btn primary">Tandai Lunas & Simpan</button>
        <button id="saveUnpaid" class="btn ghost">Simpan sebagai Belum Bayar</button>
      </div>
      <div class="chips" style="margin-top:10px">
        <span class="chip">Pasien: <span id="qrPatient" class="kbd"></span></span>
        <span class="chip">Nominal: Rp <span id="qrAmount" class="kbd"></span></span>
        <span class="chip">Waktu: <span id="qrTime" class="kbd"></span></span>
      </div>
    </div>
  </div>

  <!-- Report Modal (locks to selected patient) -->
  <div id="reportModal" class="modal" role="dialog" aria-modal="true" aria-label="Laporan Input">
    <div class="sheet">
      <div class="inline" style="justify-content:space-between;align-items:center">
        <h3>Laporan Pasien</h3>
        <div class="inline">
          <button id="exportCsv" class="btn ghost">Export CSV</button>
          <button id="closeReport" class="btn ghost">Tutup</button>
        </div>
      </div>

      <div class="chips" style="margin-top:8px" id="summaryChips"></div>

      <div class="scroll" style="margin-top:8px">
        <table id="reportTable" aria-label="Tabel laporan">
          <thead>
            <tr>
              <th>Waktu</th>
              <th>Pasien</th>
              <th>Perawat</th>
              <th>Lokasi</th>
              <th>Jenis Terapi</th>
              <th>Durasi</th>
              <th>Amp</th>
              <th>Nominal</th>
              <th>Status</th>
              <th>ID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- QRCode generator (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // ------- Config: Pricing (auto) -------
    // Atur tarif di sini. Default: Rp 75.000 per 30 menit.
    const PRICING = {
      per30: 75000, // ubah sesuai kebijakan klinik
      overrides: { // contoh override per program (opsional)
        // 'Biofeedback 1': 90000,
      }
    };

    // ------- State & Utilities -------
    const $ = (sel) => document.querySelector(sel);
    const nowStr = () => new Date().toLocaleString('id-ID', { hour12:false });
    const storage = {
      get key(){ return 'stimelEntriesV1'; },
      get all(){ return JSON.parse(localStorage.getItem(this.key)||'[]'); },
      set all(arr){ localStorage.setItem(this.key, JSON.stringify(arr)); },
      push(x){ const arr=this.all; arr.unshift(x); this.all=arr; },
      clear(){ localStorage.removeItem(this.key); }
    };
    const counters = {
      get key(){ return 'stimelTherapyCountersV1'; },
      get all(){ return JSON.parse(localStorage.getItem(this.key)||'{}'); },
      set all(obj){ localStorage.setItem(this.key, JSON.stringify(obj)); },
      inc(type){ const c=this.all; c[type]=(c[type]||0)+1; this.all=c; },
      get(type){ return this.all[type]||0; },
      clear(){ localStorage.removeItem(this.key); }
    };
    const people = {
      get key(){ return 'stimelPeopleV1'; },
      get all(){ return JSON.parse(localStorage.getItem(this.key)||'{"nurse":"","patients":[]}'); },
      set all(obj){ localStorage.setItem(this.key, JSON.stringify(obj)); },
      saveNurse(name){ const o=this.all; o.nurse=name; this.all=o; },
      addPatient(name){ if(!name) return; const o=this.all; if(!o.patients.includes(name)) o.patients.push(name); this.all=o; },
      clear(){ localStorage.removeItem(this.key); }
    };

    // ------- Elements -------
    const dots = $('#stepDots');
    const nurseEl = $('#nurse');
    const patientEl = $('#patient');
    const nowLabel = $('#nowStr');
    const autoSaveBadge = $('#autoSaveBadge');
    const locationHidden = $('#location');
    const locGrid = $('#locGrid');
    const therapyEl = $('#therapy');
    const therapyCounterEl = $('#therapyCounter');
    const durationEl = $('#duration');
    const amplitudeRange = $('#amplitude');
    const amplitudeNum = $('#amplitudeNum');
    const amountDisplay = $('#amountDisplay');

    const backBtn = $('#backBtn');
    const nextBtn = $('#nextBtn');
    const submitBtn = $('#submitBtn');
    const toast = $('#toast');

    const payModal = $('#payModal');
    const closePay = $('#closePay');
    const qrcodeBox = $('#qrcode');
    const qrPatient = $('#qrPatient');
    const qrAmount = $('#qrAmount');
    const qrTime = $('#qrTime');
    const markPaid = $('#markPaid');
    const saveUnpaid = $('#saveUnpaid');

    const reportBtn = $('#reportBtn');
    const reportModal = $('#reportModal');
    const closeReport = $('#closeReport');
    const reportTable = $('#reportTable tbody');
    const exportCsv = $('#exportCsv');
    const summaryChips = $('#summaryChips');

    const resetAllBtn = $('#resetAllBtn');

    // ------- Stepper (logical only; UI is single card) -------
    const steps = [
      'Pasien + Perawat',
      'Letak Terapi',
      'Jenis Terapi',
      'Durasi + Nominal (auto)',
      'Amplitudo'
    ];
    let step = 0;

    function renderDots(){
      dots.innerHTML = steps.map((_,i)=>`<div class="dot ${i<=step?'active':''}" title="${steps[i]}"></div>`).join('');
    }
    function updateNav(){
      backBtn.style.display = step>0 ? 'inline-block' : 'none';
      nextBtn.style.display = step<steps.length-1 ? 'inline-block' : 'none';
      submitBtn.style.display = step===steps.length-1 ? 'inline-block' : 'none';
      renderDots();
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 2200);
    }

    function validateStep(){
      if(step===0){
        if(!nurseEl.value.trim()){ showToast('Isi nama perawat terlebih dahulu'); nurseEl.focus(); return false; }
        if(!patientEl.value.trim()){ showToast('Pilih/isi nama pasien terlebih dahulu'); patientEl.focus(); return false; }
        return true;
      }
      if(step===1 && !locationHidden.value){ showToast('Pilih letak terapi'); return false; }
      if(step===2 && !therapyEl.value){ showToast('Pilih jenis terapi'); therapyEl.focus(); return false; }
      if(step===3){
        const d = Number(durationEl.value);
        if(!(d>0) || d%30!==0) { showToast('Pilih durasi (kelipatan 30 menit)'); durationEl.focus(); return false; }
        return true;
      }
      return true;
    }

    function next(){ if(!validateStep()) return; if(step===0) autoSaveHeader(); step=Math.min(step+1, steps.length-1); updateNav(); }
    function back(){ step=Math.max(step-1,0); updateNav(); }

    // ------- Header auto-save (beginning requirement) -------
    function autoSaveHeader(){
      const nurse = nurseEl.value.trim();
      const patient = patientEl.value.trim();
      if(!nurse || !patient) return;
      people.saveNurse(nurse);
      people.addPatient(patient);
      nowLabel.textContent = nowStr(); // recorded silently
      autoSaveBadge.style.display = 'inline-flex';
      setTimeout(()=>autoSaveBadge.style.display='none', 2000);
      populatePatients();
    }

    function populatePatients(){
      const {patients,nurse} = people.all;
      nurseEl.value = nurse||'';
      const dl = $('#patientList');
      dl.innerHTML = (patients||[]).map(p=>`<option value="${p}"></option>`).join('');
    }

    // ------- Location cards selection -------
    function selectLocationCard(el){
      [...locGrid.children].forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected');
      locationHidden.value = el.getAttribute('data-value');
    }
    locGrid.addEventListener('click', (e)=>{
      const card = e.target.closest('.loc-card');
      if(card) selectLocationCard(card);
    });
    locGrid.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){
        const card = e.target.closest('.loc-card');
        if(card){ e.preventDefault(); selectLocationCard(card); }
      }
    });

    // ------- Counters -------
    function updateTherapyCounter(){
      const t = therapyEl.value || '';
      therapyCounterEl.textContent = t ? counters.get(t) : 0;
      computeAndShowPrice();
    }

    // ------- Amplitude sync -------
    amplitudeRange.addEventListener('input', e=> amplitudeNum.value = e.target.value);
    amplitudeNum.addEventListener('input', e=> {
      let v = Math.max(0, Math.min(100, Number(e.target.value||0)));
      amplitudeRange.value = v; amplitudeNum.value = v;
    });

    // ------- Pricing (auto) -------
    function computePrice(){
      const dur = Number(durationEl.value||0);
      if(!dur) return 0;
      const per30 = PRICING.overrides[therapyEl.value] || PRICING.per30;
      return Math.round((dur/30) * per30);
    }
    function computeAndShowPrice(){
      const amt = computePrice();
      amountDisplay.value = amt ? 'Rp ' + amt.toLocaleString('id-ID') : '';
    }
    durationEl.addEventListener('change', computeAndShowPrice);
    therapyEl.addEventListener('change', computeAndShowPrice);

    // ------- Submit & QR -------
    let qr; // QRCode instance
    function buildPayload(statusHint='UNPAID'){
      const payload = {
        schema:'QRIS-DEMO',
        patient: patientEl.value.trim(),
        nurse: nurseEl.value.trim(),
        location: locationHidden.value,
        therapy: therapyEl.value,
        duration: Number(durationEl.value),
        amplitude: Number(amplitudeRange.value),
        amount: computePrice(),
        status: statusHint,
        at: new Date().toISOString(),
      };
      return payload;
    }

    function openPayment(){
    const params = new URLSearchParams({
  patient: patientEl.value.trim(),
  nurse: nurseEl.value.trim(),
  therapy: therapyEl.value,
  location: locationHidden.value,
  duration: durationEl.value,
  amp: amplitudeRange.value,
  amount: computePrice(),     // from index.html
  at: new Date().toISOString()
}).toString();

window.open(`payment-mock.html?${params}`, "_blank");

    }

    function finalize(status){
      const data = buildPayload(status);
      data.id = 'TX-' + Date.now() + '-' + Math.floor(Math.random()*900+100);
      storage.push(data);
      if(status==='paid'){ reportBtn.style.display = 'inline-block'; }
      counters.inc(data.therapy);
      updateTherapyCounter();
      payModal.classList.remove('show');
      showToast('Data tersimpan ('+ (status==='paid'?'Lunas':'Belum bayar') +')');
      // reset form (except nurse/patient suggestions)
      locationHidden.value = '';
      [...locGrid.children].forEach(c=>c.classList.remove('selected'));
      therapyEl.value = '';
      durationEl.value = '';
      amplitudeRange.value = 30; amplitudeNum.value = 30;
      amountDisplay.value = '';
      step = 0; updateNav();
      // no auto-open report here; button now available when needed
    }

    // ------- Report (locks to selected patient) -------
    let contextPatient = '';
    function refreshReportTable(){
      const rows = storage.all.filter(r => r.patient === contextPatient);
      reportTable.innerHTML = rows.map(r=>`
        <tr>
          <td>${new Date(r.at).toLocaleString('id-ID',{hour12:false})}</td>
          <td>${r.patient||''}</td>
          <td>${r.nurse||''}</td>
          <td>${r.location||''}</td>
          <td>${r.therapy||''}</td>
          <td>${r.duration||''}</td>
          <td>${r.amplitude||''}</td>
          <td>Rp ${(r.amount||0).toLocaleString('id-ID')}</td>
          <td>${r.status==='paid'?'Lunas':'Belum bayar'}</td>
          <td class="kbd">${r.id||''}</td>
        </tr>
      `).join('');

      // Build summary chips per therapy
      const agg = {};
      for(const r of rows){ agg[r.therapy] = (agg[r.therapy]||0) + 1; }
      summaryChips.innerHTML = [
        `<span class="chip">Pasien: <strong class="kbd" style="margin-left:6px">${contextPatient||'â€”'}</strong></span>`,
        ...(Object.keys(agg).length
          ? Object.entries(agg).map(([k,v])=>`<span class="chip">${k}: <strong style="margin-left:6px">${v}</strong></span>`)
          : ['<div class="muted">Belum ada data untuk pasien ini.</div>']
        )
      ].join('');
    }

    function exportToCsv(){
      const rows = storage.all.filter(r=> r.patient===contextPatient);
      const header = ['Waktu','Pasien','Perawat','Lokasi','Jenis Terapi','Durasi','Amplitudo','Nominal','Status','ID'];
      const data = rows.map(r=>[
        new Date(r.at).toLocaleString('id-ID',{hour12:false}), r.patient, r.nurse, r.location, r.therapy, r.duration, r.amplitude, r.amount, r.status, r.id
      ]);
      const csv = [header, ...data].map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `stimel-entries-${(contextPatient||'pasien')}.csv`; a.click();
      URL.revokeObjectURL(url);
    }

    // ------- Events -------
    nextBtn.addEventListener('click', next);
    backBtn.addEventListener('click', back);
    submitBtn.addEventListener('click', ()=>{ if(!validateStep()) return; autoSaveHeader(); openPayment(); });
    closePay.addEventListener('click', ()=> payModal.classList.remove('show'));
    markPaid.addEventListener('click', ()=> finalize('paid'));
    saveUnpaid.addEventListener('click', ()=> finalize('unpaid'));

    therapyEl.addEventListener('change', updateTherapyCounter);
    patientEl.addEventListener('change', autoSaveHeader);
    nurseEl.addEventListener('change', autoSaveHeader);

    reportBtn.addEventListener('click', ()=>{
      contextPatient = patientEl.value.trim();
      refreshReportTable();
      reportModal.classList.add('show');
    });
    closeReport.addEventListener('click', ()=> reportModal.classList.remove('show'));
    exportCsv.addEventListener('click', exportToCsv);

    resetAllBtn.addEventListener('click', ()=>{
      if(confirm('Hapus SEMUA data lokal (input, counter, daftar pasien/perawat)?')){
        storage.clear(); counters.clear(); people.clear();
        populatePatients(); updateTherapyCounter();
        showToast('Semua data lokal dihapus');
        reportBtn.style.display = 'none';
      }
    });

    // ------- Init -------
    function tick(){ if(nowLabel) nowLabel.textContent = nowStr(); }
    setInterval(tick, 1000); tick();
    updateNav(); renderDots(); populatePatients(); updateTherapyCounter();
    computeAndShowPrice();
    // Report button appears only after a successful payment; ensure hidden on load
    reportBtn.style.display = 'none';
  </script>
</body>
</html>